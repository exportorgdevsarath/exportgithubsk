name: dev-deploy
description: dev-deploy action for the pipeline

inputs:
  CLOUD_RUN_DEFAULT_SERVICE_ACCOUNT:
    required: true

  SERVICE_ACCOUNT_KEYFILE_JSON:
    required: true

  PROJECT_ID:
    required: true

runs:
  using: "composite"

  steps:
  - name: Checkout repository
    uses: actions/checkout@v3

  - name: Set up Google Cloud SDK
    uses: google-github-actions/setup-gcloud@v1
    with:
      service_account_key: ${{ inputs.SERVICE_ACCOUNT_KEYFILE_JSON }}
      project_id: ${{ inputs.PROJECT_ID }}

  - name: Install dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y openjdk-17-jdk maven zip

  - name: Build the cloud function
    run: |
      mkdir -p deployment
      cd BackendApp/src/functions/java
      mvn clean package
      ls -l target
      cp target/csv-to-excel-function-1.0-SNAPSHOT.jar ../../../../deployment/
      cp -r src ../../../../deployment/src/
      cp pom.xml ../../../../deployment/
      cd ../../../../deployment
      zip -r ../csv-to-excel-function-deployment.zip .
      cd ..

  - name: Upload to Google Cloud Storage
    run: |
      gsutil cp csv-to-excel-function-deployment.zip gs://$PROJECT_ID-cf-configuration/cloudfunctions/

  - name: Deploy Cloud Function
    run: |
      gcloud functions deploy CSVToExcelDevFunction --gen2 --entry-point com.vb.csvtoexcel.CSVToExcelDevFunction --runtime ${{ inputs.CLOUD_FUN_RUNTIME }} --trigger-http --memory ${{ inputs.CLOUD_FUN_MEMORY }} --timeout ${{ inputs.CLOUD_FUN_TIMEOUT }} --region ${{ inputs.CLOUD_FUN_REGION }} --source gs://$PROJECT_ID-cf-configuration/cloudfunctions/csv-to-excel-function-deployment.zip
  
  steps:
  - name: Deploying image...
    shell: sh
    run: |
      export CLOUDSDK_CORE_DISABLE_PROMPTS=1
      gcloud beta run deploy exportgithubsk --use-http2 --service-account=${{inputs.CLOUD_RUN_DEFAULT_SERVICE_ACCOUNT}} --image=europe-west1-docker.pkg.dev/vb-eva-gen/exportgithubsk-repository/exportgithubsk --vpc-connector=projects/vb-eva-gen/locations/europe-west1/connectors/eva-modeller --region=europe-west1 --platform=managed --timeout=600s --concurrency=80 --cpu-boost --no-use-http2 --allow-unauthenticated --quiet --vpc-egress=private-ranges-only --user-output-enabled --port=9090 --max-instances=10 --min-instances=0 --cpu=2 --memory=1Gi --set-env-vars JAVA_TOOL_OPTIONS="-Xss256k" --execution-environment=gen2 --update-secrets=SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-ID=SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-ID:latest,SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-SECRET=SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-SECRET:latest
